name: HAC Forecast Automation

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  run-hac:
    runs-on: ubuntu-latest
    name: Executar previsÃ£o HAC automÃ¡tica

    steps:
      # 1. Checkout do repositÃ³rio
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. Python
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3. InstalaÃ§Ã£o de dependÃªncias
      - name: ğŸ“¦ Instalar dependÃªncias HAC
        run: |
          echo "ğŸ”§ Atualizando pip..."
          python -m pip install --upgrade pip

          echo "ğŸ“¦ Instalando dependÃªncias do projeto..."
          pip install -r requirements.txt

          echo "ğŸ“Œ Instalando XGBoost (garantia)"
          pip install xgboost || echo "XGBoost falhou, tentando alternativa..."
          pip install xgboost==1.7.6 || true

          echo "ğŸ¨ Instalando pacotes opcionais"
          pip install seaborn plotly kaleido

          echo "ğŸ¤– Tentando instalar TensorFlow (opcional)"
          pip install tensorflow-cpu || echo "TensorFlow nÃ£o instalado"

      # 4. Coletar dados solares
      - name: ğŸŒ Coletar dados solares
        run: |
          echo "ğŸ“¡ Coletando dados do NOAA/NASA..."
          python src/data_fetcher.py

      # 5. Rodar previsÃ£o
      - name: ğŸ”® Rodar previsÃ£o heliogeofÃ­sica
        run: |
          echo "ğŸ§  Rodando modelo HAC Predictive..."
          python src/heliopredictive.py

      # 6. ValidaÃ§Ã£o
      - name: ğŸ§ª Rodar validaÃ§Ã£o comparativa
        run: |
          echo "ğŸ“Š ValidaÃ§Ã£o HAC..."
          python src/hac_validation.py

      # 7. OrganizaÃ§Ã£o dos resultados
      - name: ğŸ’¾ Organizar resultados
        run: |
          echo "ğŸ“‚ Organizando resultados..."
          mkdir -p results plots data logs

          # Movendo arquivos com fallback seguro
          mv ./*.png plots/ 2>/dev/null || true
          mv ./*.csv data/ 2>/dev/null || true
          mv ./*.json results/ 2>/dev/null || true
          mv ./*.log logs/ 2>/dev/null || true

          echo "ğŸ§¹ Limpando resÃ­duos..."
          rm -rf data/results/ 2>/dev/null || true

      # 8. Commit e push
      - name: ğŸ“¤ Commit e Push dos Resultados
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Commitando alteraÃ§Ãµes..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "Nenhuma alteraÃ§Ã£o para commitar."
            exit 0
          fi

          git commit -m "ğŸŒ AtualizaÃ§Ã£o automÃ¡tica: PrevisÃµes HAC + ValidaÃ§Ã£o $(date +'%Y-%m-%d %H:%M')"

          echo "ğŸ”ƒ Sincronizando com main..."
          git pull origin main --no-rebase -X theirs

          echo "â¬†ï¸ Enviando para o repositÃ³rio..."
          git push origin main

      # 9. Artefatos
      - name: ğŸ“Š Upload dos resultados como artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hac-validation-results
          path: |
            results/
            plots/
            data/
            logs/
          retention-days: 30
